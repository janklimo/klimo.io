<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico" />
<link rel="icon" type="image/png" href="/images/touch-icon-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/images/apple-touch-icon-180x180.png" sizes="180x180" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/images/apple-touch-icon-167x167.png" sizes="167x167" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/images/apple-touch-icon-152x152.png" sizes="152x152" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/images/apple-touch-icon-144x144.png" sizes="144x144" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/images/apple-touch-icon-120x120.png" sizes="120x120" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/images/apple-touch-icon-114x114.png" sizes="114x114" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/images/apple-touch-icon-76x76.png" sizes="76x76" />
<link rel="apple-touch-icon-precomposed" type="image/png" href="/images/apple-touch-icon-72x72.png" sizes="72x72" />
<link rel="apple-touch-icon-precomposed" type="image/x-icon" href="/images/apple-touch-icon-precomposed.png" />
<link rel="apple-touch-startup-image" type="image/x-icon" href="/images/apple-touch-startup-image.png" />
<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico" />
        <title>Automating AWS Workflows &middot; A blog by Jan Klimo</title>
        <meta name="description" content="Using AWS CLI to automatically upload assets to S3 and invalidate CloudFront cache, both locally and on CircleCI.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.55.6" />
        <meta name="robots" content="index,follow">
        <meta property="og:title" content="Automating AWS Workflows">
<meta property="og:description" content="Using AWS CLI to automatically upload assets to S3 and invalidate CloudFront cache, both locally and on CircleCI.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.klimo.io/posts/optimizing-asset-publishing-workflow-aws/">
<meta property="og:image" content="https://www.klimo.io/images/cover.png" />

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@janklimo">
<meta name="twitter:creator" content="@janklimo">
<meta name="twitter:title" content="Automating AWS Workflows">
<meta name="twitter:description" content="Using AWS CLI to automatically upload assets to S3 and invalidate CloudFront cache, both locally and on CircleCI.">
<meta name="twitter:image" content="https://www.klimo.io/images/cover.png">
        <link rel="stylesheet" href="/dist/styles.css">
        <link href="maxcdn.bootstrapcdn.com" rel="preconnect" crossorigin>
        <link href="fonts.googleapis.com" rel="preconnect" crossorigin>
        <link href="www.googletagmanager.com" rel="preconnect" crossorigin>
        <link href="cdnjs.cloudflare.com" rel="preconnect" crossorigin>
        <link href="//fonts.googleapis.com/css?family=PT+Sans:400,600,700,900" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134476453-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'UA-134476453-1');
        </script>
    </head>
    <body>
        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        <h1 class="site-title">
                            <a title="Klimo.io" href="/">Klimo.io</a>
                        </h1>
                    </div>
                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Blog" href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a title="Projects" href="/projects/">Projects</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Automating AWS Workflows</h1>
    <p class="post-date post-line">
        <span><time datetime="2019-08-08" itemprop="datePublished">August 8, 2019</time></span>
        
            <span> â€¢ 2 min read</span>
        
    </p>
</header>


        <div class="post-content clearfix">
    

    

<blockquote>
<p>This article shows you how to use AWS CLI programmatically to automate your deployment process. We&rsquo;ll upload assets to S3 (specifying their ACL and caching behavior) and invalidate CloudFront cache. Starting with a local shell script, we conclude with plugging the script into our CircleCI workflow. It may be especially useful if you&rsquo;re using Rails with Webpacker, but no experience with Rails is required.</p>
</blockquote>

<p>My latest Shopify app <a href="https://apps.shopify.com/robin-pro-image-gallery" target="_blank">Robin PRO</a> renders image galleries on customer stores. When the store loads, it fetches a remote script (<code>client.js</code>) together with a stylesheet (<code>client.css</code>), requests gallery data and renders the result.</p>

<h4 id="how-to-serve-these-assets">How to serve these assets?</h4>

<p>All the app assets are served from a CDN, so why not just serve them from the same distribution, right? There are 2 challenges with this:</p>

<ol>
<li>When creating a <a href="https://help.shopify.com/en/api/reference/online-store/scripttag" target="_blank">script tag</a> with Shopify&rsquo;s API, you need to provide a URL of the remote script. This means that the URL cannot change, otherwise the script tag would point to a wrong location. Rails fingerprints compiled assets, so their URL changes with every change of their contents.</li>
<li>I split JavaScript bundles into chunks in production but I can only have one remote script.</li>
</ol>

<p>Given these constraints, I settled on the following workflow:</p>

<ol>
<li>Temporarily disable code splitting of JS bundles.</li>
<li>Precompile assets for production locally.</li>
<li>Upload <a href="https://d2yb226523mvk3.cloudfront.net/js/client.js" target="_blank"><code>client.js</code></a> and <a href="https://d2yb226523mvk3.cloudfront.net/css/client.css" target="_blank"><code>client.css</code></a> to S3. This is a standalone bucket with its own CloudFront distribution. It gives me asset URLs the app can depend on.</li>
<li>Set their caching behavior and <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl" target="_blank">ACL</a> so that they come with public access. Setting <code>Cache-Control</code> header is important. The URL of the asset never changes, so on one hand, we want to make sure that no browsers cache them forever, on the other hand, basic caching helps performance.</li>
<li>Invalidate CloudFront cache to force clients to fetch the latest assets.</li>
</ol>

<p>This only takes a few minutes, so it was acceptable to do manually a couple of times.</p>

</div>

        <footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="/tags/aws/">AWS</a>, 
            
                <a href="/tags/circleci/">CircleCI</a>, 
            
                <a href="/tags/shell-scripting/">Shell scripting</a>, 
            
                <a href="/tags/rails/">Rails</a>
            
        </p>
    

    <div class="share">
        
        <a class="icon-twitter" href="https://twitter.com/share?text=Automating%20AWS%20Workflows by @janklimo&hashtags=AWS%2c%20CircleCI%2c%20Shell%20scripting%2c%20Rails&url=https%3a%2f%2fwww.klimo.io%2fposts%2foptimizing-asset-publishing-workflow-aws%2f"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
            <i class="fa fa-twitter"></i>
            <span class="hidden">Twitter</span>
        </a>
    </div>

    
<div id="mc_embed_signup">
    <form action="https://klimo.us2.list-manage.com/subscribe/post?u=60a38ce5acde10117dd351c1c&amp;id=89ad965331" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div id="mc_embed_signup_scroll">
            <label for="mce-EMAIL">Subscribe to get my latest content by email</label>
            <p class="intro">Let me notify you when I publish a new post (once or twice a month).</p>
            <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
            
            <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_60a38ce5acde10117dd351c1c_89ad965331" tabindex="-1" value=""></div>
            <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
        </div>
    </form>
</div>

</footer>
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Klimo.io" href="/">Klimo.io</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>
                <div class="social-icons">
    
        <a class="button-square button-social hint--top" data-hint="Twitter" title="Twitter" href="https://twitter.com/janklimo" target="_blank">
            <i class="fa fa-twitter"></i>
        </a>
    
    
        <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/janklimo" target="_blank">
            <i class="fa fa-github-alt"></i>
        </a>
    
    
        <a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href="https://stackoverflow.com/users/3678689/jan-klimo" target="_blank">
            <i class="fa fa-stack-overflow"></i>
        </a>
    
    
        <a class="button-square button-social hint--top" data-hint="LinkedIn" title="LinkedIn" href="https://www.linkedin.com/in/janklimo/" target="_blank">
            <i class="fa fa-linkedin"></i>
        </a>
    
    <a class="button-square" target="_blank" href="/index.xml"><i class="fa fa-rss"></i></a>
</div>
            </div>
        </footer>

        <script src="/js/jquery-1.11.3.min.js"></script>
        
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        
        <script src="/js/scripts.js"></script>
    </body>
</html>

